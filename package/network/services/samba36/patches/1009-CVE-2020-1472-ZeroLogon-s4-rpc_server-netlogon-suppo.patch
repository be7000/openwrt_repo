From f9b772bf286b7bde6a29cb8d7bbd241638daf5e7 Mon Sep 17 00:00:00 2001
From: Stefan Metzmacher <metze@samba.org>
Date: Wed, 16 Sep 2020 10:56:53 +0200
Subject: [PATCH] CVE-2020-1472(ZeroLogon): s4:rpc_server/netlogon: support
 "server require schannel:WORKSTATION$ = no"

This allows to add expections for individual workstations, when using "server schannel = yes".
"server schannel = auto" is very insecure and will be removed soon.

BUG: https://bugzilla.samba.org/show_bug.cgi?id=14497

Signed-off-by: Stefan Metzmacher <metze@samba.org>
---
Index: samba-3.6.25/source4/rpc_server/netlogon/dcerpc_netlogon.c
===================================================================
--- samba-3.6.25.orig/source4/rpc_server/netlogon/dcerpc_netlogon.c
+++ samba-3.6.25/source4/rpc_server/netlogon/dcerpc_netlogon.c
@@ -369,6 +369,7 @@ static NTSTATUS dcesrv_netr_creds_server
 	NTSTATUS nt_status;
 	struct dcerpc_auth *auth_info = dce_call->conn->auth_state.auth_info;
 	bool schannel_global_required = false; /* Should be lpcfg_schannel_server() == true */
+	bool schannel_required = schannel_global_required;
 	struct netlogon_creds_CredentialState *creds = NULL;
 	enum dcerpc_AuthType auth_type = DCERPC_AUTH_TYPE_NONE;
 	uint16_t opnum = dce_call->pkt.u.request.opnum;
@@ -391,7 +392,13 @@ static NTSTATUS dcesrv_netr_creds_server
 		return nt_status;
 	}
 
-	if (schannel_global_required) {
+	schannel_required = lpcfg_parm_bool(dce_call->conn->dce_ctx->lp_ctx,
+					    NULL,
+					    "server require schannel",
+					    creds->account_name,
+					    schannel_global_required);
+
+	if (schannel_required) {
 		if (auth_type == DCERPC_AUTH_TYPE_SCHANNEL) {
 			*creds_out = creds;
 			return NT_STATUS_OK;
