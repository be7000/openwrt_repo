#!/bin/sh
# Copyright (c) 2017 The Linux Foundation. All rights reserved.
#
# Permission to use, copy, modify, and/or distribute this software for any
# purpose with or without fee is hereby granted, provided that the above
# copyright notice and this permission notice appear in all copies.
#
# THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
# WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
# MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
# ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
# WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
# ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
# OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.

. /lib/ar71xx.sh

do_load_ath10k_board_bin() {
	local board=$(ar71xx_board_name)
	local mtdblock=$(find_mtd_part art)

        [ -n "$mtdblock" ] || return

	local dir="/lib/firmware/ath10k/QCA988X/hw2.0"
        local cal_data_path="/tmp"

	# load board.bin
	case "$board" in
	        ap152)
			mkdir -p ${dir}
	                dd if=${mtdblock} of=${dir}/board.bin \
	                        bs=1 skip=20480 count=2116
                        mkdir -p ${cal_data_path}
                        dd if=${mtdblock} of=${cal_data_path}/wifi0.caldata bs=32 count=377 skip=128
                        dd if=${mtdblock} of=${cal_data_path}/wifi1.caldata bs=32 count=377 skip=640
	        ;;
                ap147 | ap147ioe* | ap151 | ap135 | ap137 | cus531mp3-nand)
                        mkdir -p ${cal_data_path}
                        dd if=${mtdblock} of=${cal_data_path}/wifi0.caldata bs=32 count=377 skip=128
                        dd if=${mtdblock} of=${cal_data_path}/wifi1.caldata bs=32 count=377 skip=640
                ;;
                *)
                        echo "Support to copy caldata is not there for $board"
                ;;
	esac
}

boot_hook_add preinit_main do_load_ath10k_board_bin
